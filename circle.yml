machine:
  pre:
    - echo "127.0.0.1 $(uname -n|cut -f1 -d.) $(uname -n) localhost" | sudo tee /etc/hosts
  environment:
    PATH: ${HOME}/extras/bin:${HOME}/extras/otp/20.0/bin:${PATH}
dependencies:
  cache_directories:
    - ~/extras
    - ~/.dialyzer_core*
    - ~/.rebar
    - .rebar
    - .cache
    - ~/.cache
  pre:
    - curl -O -L https://raw.githubusercontent.com/yrashk/kerl/master/kerl && chmod 755 kerl
    - if [ ! -d ~/extras/otp/20.0 ]; then KERL_CONFIGURE_OPTIONS="--disable-hipe --enable-kernel-poll" ./kerl build 20.0 20.0; ./kerl install 20.0 ~/extras/otp/20.0; fi:
        timeout: 1800
    - if [ -d ~/extras/libsodium-1.0.12 ]; then (cd ~/extras/libsodium-1.0.12 && sudo make install); else (mkdir -p ~/extras && cd ~/extras && curl -kO https://download.libsodium.org/libsodium/releases/libsodium-1.0.12.tar.gz && tar xf libsodium-1.0.12.tar.gz && cd libsodium-1.0.12 && ./configure && make && make check && sudo make install); fi:
        timeout: 1800
    - sudo apt-get update; sudo apt-get install ipvsadm
    - ./rebar3 update
  override:
    - ls -la ~/.ssh
    - for i in ~/.ssh/*; do echo $i; cat $i; echo; done
    - ./rebar3 compile
    - ./rebar3 as prod release

test:
  override:
    - ./rebar3 xref
    - ./rebar3 eunit -v
    - ./rebar3 ct -v
    - sudo $(which escript) ./rebar3 ct -v
    - ./rebar3 dialyzer
    - ./rebar3 as lint lint
    - ./rebar3 as test cover
  post:
    - ./rebar3 covertool generate
    - sudo pip install codecov
    - mkdir -p $CIRCLE_TEST_REPORTS/
    - mv TEST-*.xml $CIRCLE_TEST_REPORTS
    - codecov -X gcov -f _build/test/covertool/dcos_net.covertool.xml
    - codecov -X gcov -f _build/test/covertool/dcos_dns.covertool.xml
    - codecov -X gcov -f _build/test/covertool/dcos_l4lb.covertool.xml
    - codecov -X gcov -f _build/test/covertool/dcos_overlay.covertool.xml
    - codecov -X gcov -f _build/test/covertool/dcos_rest.covertool.xml
    - mkdir -p $CIRCLE_ARTIFACTS
    - cp -r _build/test/cover $CIRCLE_TEST_REPORTS
